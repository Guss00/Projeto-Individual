<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <link
      rel="shortcut icon"
      href="../assets/icon/favicon2.ico"
      type="image/x-icon"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Letras em Ação | Biblioteca</title>

    <link rel="stylesheet" href="../CSS/dasboard.css" />
    <link rel="stylesheet" href="../CSS/navbarDash.css">

    <link rel="icon" type="image/png" href="../assests/img/imagenloginho.png"/>

    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>

      <div class="dash-right">
        <div class="header">
          <div class="container">
            <div class="titulo">
              <img src="../assests/img/Logo.jpeg" alt="" />
            </div>
            <ul class="navbar">
              <li>
                <a href="paginaInformacao.html" style="margin-left: -50rem">Informações</a>
              </li>
              <li>
                <a href="biblioteca.html" style="margin-left: -40rem">Biblioteca</a>
              </li>
              <li>
                <a href="dashboard.html" style="margin-left: -30rem">Dashboard</a>
              </li>
              <li>
                <a href="comunidade.html" style="margin-left: -20rem"
                  >Comunidade</a
                >
              </li>
              <li style="margin-left: -10rem">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16">
                  <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                </svg> Usuario&nbsp; <span id="b_usuario">usuário</span>
              </li>
              <li style="margin-right: -8rem; margin-left: 5rem;">
                <a onclick="Sair()">Sair&nbsp;&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-box-arrow-left" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"/>
                  <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
                </svg></a>
              </li>
            </ul>
          </div>
        </div>

    <div class="ajuda"></div>
  
        <div class="avisos">
          <div id="alerta"></div>
          <div class="container">
            <div class="div-form">
              <h1>Publicar um Livro na Biblioteca Pessoal</h1>
              <form
                id="form_postagem"
                method="post"
                onsubmit="return publicar()"
              >
                <label>
                  <span>Título do Livro:</span>
                  <br />
                  <input
                    name="titulo"
                    id="titulo"
                    maxlength="100"
                    type="text"
                  />
                </label>
                <label>
                  <span>Gênero do Livro:</span>
                  <br>
                  <select name="genero" id="genero">
                    <option value="null">Nenhum</option>
                    <option value="Ficção científica">Ficção científica</option>
                    <option value="Romance">Romance</option>
                    <option value="Suspense">Suspense</option>
                    <option value="Terror">Terror</option>
                    <option value="Aventura">Aventura</option>
                    <option value="Crime e Mistério">Crime e Mistério</option>
                    <option value="História">História</option>
                    <option value="Biografia">Biografia</option>
                    <option value="Autobiografia">Autobiografia</option>
                    <option value="Poesia">Poesia</option>
                    <option value="Contos">Contos</option>
                    <option value="Fantasia">Fantasia</option>
                    <option value="Mitologia">Mitologia</option>
                    <option value="Literatura Infantil e Juvenil">
                      Literatura Infantil e Juvenil
                    </option>
                    <option value="Drama">Drama</option>
                    <option value="Comédia">Comédia</option>
                    <option value="Ensaio">Ensaio</option>
                    <option value="Crônica">Crônica</option>
                    <option value="Guias de Viagem">Guias de Viagem</option>
                    <option value="Livros de autoajuda e desenvolvimento pessoal">
                      Livros de autoajuda e desenvolvimento pessoal
                    </option>
                  </select>
                </label>
                <br />
                <button id="adicionarLivro">
                  Adicionar
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    class="bi bi-plus-lg"
                    viewBox="0 0 16 16"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"
                    />
                  </svg>
                </button>
              </form>
            </div>

            <h1 id="publicacoesBiblioteca">Biblioteca do Usuário&nbsp;<span id="u_usuario"></span></h1>
            <div class="div-results">
              <div id="feed_container" class="feed-container"></div>
            </div>
          </div>
        </div>

      </div>
 
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.all.min.js"></script>

  </body>
</html>

<script>

const swalWithBootstrapButtons = Swal.mixin({
  customClass: {
    confirmButton: 'btn btn-success',
    cancelButton: 'btn btn-danger'
  },
  buttonsStyling: false
})

  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  u_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  function limparFormulario() {
    document.getElementById("form_postagem").reset();
  }

  function Sair() {
    sessionStorage.clear();
    window.location = "../login.html";
  }

  function publicar() {
    var idUsuario = sessionStorage.ID_USUARIO;

    var corpo = {
      titulo: form_postagem.titulo.value,
      genero: form_postagem.genero.value,
    };

    fetch(`/biblioteca/publicar/${idUsuario}`, {
      method: "post",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(corpo),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          
          window.location = "biblioteca.html";
          limparFormulario();
        } else if (resposta.status == 404) {
          window.alert("Deu 404!");
        } else {
          throw (
            "Houve um erro ao tentar realizar a postagem! Código da resposta: " +
            resposta.status
          );
        }
      })
      .catch(function (resposta) {
        console.error("Erro: ", resposta);
      });

    return false;
  }

  function editar(nome) {

    sessionStorage.setItem("ID_POSTAGEM_EDITANDO", nome);
    
    window.location = "./edicao-biblioteca.html"

  }

  function deletar(nome) {

    sessionStorage.setItem("ID_POSTAGEM_EDITANDO", nome);
    
    var idUsuario = sessionStorage.getItem("ID_USUARIO");

    swalWithBootstrapButtons.fire({
      title: 'Você tem certeza que quer deletar esse livro?',
      text: "Você não pode reverter isso!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Sim, delete!',
      cancelButtonText: 'Não, cancela!',
      reverseButtons: true
    }).then((result) => {
    if (result.isConfirmed) {

      swalWithBootstrapButtons.fire(
        'Deletado!',
        'Seu livro foi deletado',
        'success'
      )

    fetch(`/biblioteca/deletar/${idUsuario}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nomeAntigo: sessionStorage.getItem("ID_POSTAGEM_EDITANDO"),
      }),
    })
      .then(function (resposta) {
        if (resposta.ok) {
          
          window.location = "biblioteca.html";
        } else if (resposta.status == 404) {
        } else {
          throw (
            "Houve um erro ao tentar deletar a postagem! Código da resposta: " +
            resposta.status
          );
        }
      })
      .catch(function (erro) {
        console.log("#ERRO: ", erro);
    
      });
  } else if (
    result.dismiss === Swal.DismissReason.cancel
  ) {
    swalWithBootstrapButtons.fire(
      'Cancelado',
      'Seu livro está a salvo! :)',
      'error'
    )
  }
})


    // fetch(`/biblioteca/deletar/${idUsuario}`, {
    //   method: "DELETE",
    //   headers: {
    //     "Content-Type": "application/json",
    //   },
    //   body: JSON.stringify({
    //     nomeAntigo: sessionStorage.getItem("ID_POSTAGEM_EDITANDO"),
    //   }),
    // })
    //   .then(function (resposta) {
    //     if (resposta.ok) {
          
    //       window.location = "biblioteca.html";
    //     } else if (resposta.status == 404) {
    //     } else {
    //       throw (
    //         "Houve um erro ao tentar deletar a postagem! Código da resposta: " +
    //         resposta.status
    //       );
    //     }
    //   })
    //   .catch(function (erro) {
    //     console.log("#ERRO: ", erro);
    //   });
  }

  function atualizarFeed() {
    var idUsuario = sessionStorage.getItem("ID_USUARIO");

    fetch(`/biblioteca/listar/${idUsuario}`)
      .then(function (resposta) {
        if (resposta.ok) {
          if (resposta.status == 204) {
            var feed = document.getElementById("feed_container");
            var mensagem = document.createElement("span");
            mensagem.innerHTML = "Nenhum livro encontrado na biblioteca.";
            feed.appendChild(mensagem);
            throw "Nenhum resultado encontrado!!";
          }

          resposta.json().then(function (resposta) {

            var feed = document.getElementById("feed_container");
            feed.innerHTML = "";

            for (var i = 0; i < resposta.length; i++) {
              var publicacao = resposta[i];

              var divPublicacao = document.createElement("div");
              var spanTitulo = document.createElement("span");
              var divDescricao = document.createElement("div");
              var divButtons = document.createElement("div");
              var btnEditar = document.createElement("button");
              var btnDeletar = document.createElement("button");

              spanTitulo.innerHTML = "Título: <b>" + publicacao.nome + "</b>";
              divDescricao.innerHTML =
                "Genero: <b>" + publicacao.genero + "</b>";
              btnEditar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
  <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001zm-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708l-1.585-1.585z"/>
</svg> Editar`;
              btnDeletar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
  <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
</svg> Deletar`;

              divPublicacao.className = "publicacao";
              spanTitulo.className = "publicacao-titulo";
              divDescricao.className = "publicacao-descricao";

              divButtons.className = "div-buttons";

              btnEditar.className = "publicacao-btn-editar";
              btnEditar.id = "btnEditar" + publicacao.nome;
              btnEditar.setAttribute("onclick", `editar('${publicacao.nome}')`);

              btnDeletar.className = "publicacao-btn-editar";
              btnDeletar.id = "btnDeletar" + publicacao.nome;
              btnDeletar.setAttribute(
                "onclick",
                `deletar('${publicacao.nome}')`
              );

              divPublicacao.appendChild(spanTitulo);
              divPublicacao.appendChild(divDescricao);
              divPublicacao.appendChild(divButtons);
              divButtons.appendChild(btnEditar);
              divButtons.appendChild(btnDeletar);
              feed.appendChild(divPublicacao);
            }

          });
        } else {
          throw "Houve um erro na API!";
        }
      })
      .catch(function (erro) {
        console.error(erro);
      });
  }

  function testar() {

    var formulario = new URLSearchParams(
      new FormData(document.getElementById("form_postagem"))
    );

    var divResultado = document.getElementById("div_feed");

    divResultado.appendChild(document.createTextNode(formulario.get("genero")));
    divResultado.innerHTML = formulario.get("genero");


    return false;
  }

  atualizarFeed();
</script>
